!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@finos/perspective-viewer/dist/esm/utils.js"),require("@finos/perspective/dist/esm/config"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.array.flat"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.reverse"),require("core-js/modules/es.array.sort"),require("core-js/modules/es.array.unscopables.flat"),require("core-js/modules/es.number.to-fixed"),require("core-js/modules/es.promise"),require("core-js/modules/es.string.split"),require("core-js/modules/web.dom-collections.iterator")):"function"==typeof define&&define.amd?define(["@finos/perspective-viewer/dist/esm/utils.js","@finos/perspective/dist/esm/config","core-js/modules/es.symbol.description","core-js/modules/es.array.flat","core-js/modules/es.array.iterator","core-js/modules/es.array.reverse","core-js/modules/es.array.sort","core-js/modules/es.array.unscopables.flat","core-js/modules/es.number.to-fixed","core-js/modules/es.promise","core-js/modules/es.string.split","core-js/modules/web.dom-collections.iterator"],t):"object"==typeof exports?exports["perspective-viewer-datagrid"]=t(require("@finos/perspective-viewer/dist/esm/utils.js"),require("@finos/perspective/dist/esm/config"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.array.flat"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.reverse"),require("core-js/modules/es.array.sort"),require("core-js/modules/es.array.unscopables.flat"),require("core-js/modules/es.number.to-fixed"),require("core-js/modules/es.promise"),require("core-js/modules/es.string.split"),require("core-js/modules/web.dom-collections.iterator")):e["perspective-viewer-datagrid"]=t(e["@finos/perspective-viewer/dist/esm/utils.js"],e["@finos/perspective/dist/esm/config"],e["core-js/modules/es.symbol.description"],e["core-js/modules/es.array.flat"],e["core-js/modules/es.array.iterator"],e["core-js/modules/es.array.reverse"],e["core-js/modules/es.array.sort"],e["core-js/modules/es.array.unscopables.flat"],e["core-js/modules/es.number.to-fixed"],e["core-js/modules/es.promise"],e["core-js/modules/es.string.split"],e["core-js/modules/web.dom-collections.iterator"])}(window,(function(e,t,s,i,o,r,n,a,l,c,d,_){return function(e){var t={};function s(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(i,o,function(t){return e[t]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=5)}([function(t,s){t.exports=e},function(e,t,s){(e.exports=s(2)(!1)).push([e.i,'th{text-align:center;position:relative}tbody td.float,tbody td.integer,thead th.integer,thead tr:last-child th.float{text-align:right}td.pd-positive{color:#1078d1}td.pd-negative{color:#de3838}tbody td.date,tbody td.datetime,tbody td.string,thead th.date,thead th.datetime,thead th.string{text-align:left}tr td.pd-group-header,tr th{border-right:1px solid #ddd}tr th:last-child,tr:last-child th:not(.pd-group-header){border-right:none}tr:last-child th{border-bottom:1px solid #ddd}tr td span.pd-tree-group{margin-left:5px;margin-right:15px;border-left:1px solid #eee;height:19px}td,th{white-space:nowrap;font-size:12px;height:19px;padding:0 5px}tbody{transition:opacity .2s ease-in}tbody:hover tr:hover td{background:#eee;opacity:1}tr{transition:background-color .2s ease-in}table *{box-sizing:border-box}table{position:absolute;overflow:hidden}span.pd-row-header-icon{color:#aaa;padding-right:4px;font-family:"Material Icons"}span.pd-column-header-icon{font-size:10px;padding-left:3px;font-family:"Material Icons"}span.pd-row-header-icon:hover{color:#1a7da1;text-shadow:0 0 3px #1a7da1}.pd-selected td{background-color:#eee}.pd-cell-clip{overflow:hidden;text-overflow:ellipsis}td span.pd-group-name,th span.pd-group-name{margin-right:-5px;padding-right:5px;padding-left:8px;flex:1}td span.pd-group-leaf{margin-left:12px}.pd-column-resize{height:100%;width:10px;position:absolute;top:0;right:0;cursor:col-resize}',""])},function(e,t){e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s=function(e,t){var s=e[1]||"",i=e[3];if(!i)return s;if(t&&"function"==typeof btoa){var o=(n=i,"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(n))))+" */"),r=i.sources.map((function(e){return"/*# sourceURL="+i.sourceRoot+e+" */"}));return[s].concat(r).concat([o]).join("\n")}var n;return[s].join("\n")}(t,e);return t[2]?"@media "+t[2]+"{"+s+"}":s})).join("")},t.i=function(e,s){"string"==typeof e&&(e=[[null,e,""]]);for(var i={},o=0;o<this.length;o++){var r=this[o][0];"number"==typeof r&&(i[r]=!0)}for(o=0;o<e.length;o++){var n=e[o];"number"==typeof n[0]&&i[n[0]]||(s&&!n[2]?n[2]=s:s&&(n[2]="("+n[2]+") and ("+s+")"),t.push(n))}},t}},function(e,s){e.exports=t},function(e,t,s){(e.exports=s(2)(!1)).push([e.i,"div.pd-scroll-container{position:absolute;top:12px;left:12px;right:12px;bottom:12px;overflow:auto;-webkit-overflow-scrolling:auto}div.pd-virtual-panel{position:absolute;top:0;left:0;right:0;pointer-events:none}div.pd-scroll-table-clip{position:sticky;position:-webkit-sticky;top:0;left:0;overflow:hidden;width:100%;height:100%}slot{position:absolute;overflow:hidden}",""])},function(e,t,s){"use strict";s.r(t);s(6),s(7),s(8),s(9),s(10),s(11),s(12),s(13),s(14),s(15);var i,o,r=s(0),n=s(3),a=s(4),l=s.n(a),c=s(1),d=s.n(c);function _(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function h(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?_(Object(s),!0).forEach((function(t){p(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):_(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function p(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function u(){return Reflect.construct(HTMLElement,[],this.__proto__.constructor)}function m(e,t,s,i,o){var r={};return Object.keys(i).forEach((function(e){r[e]=i[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=s.slice().reverse().reduce((function(s,i){return i(e,t,s)||s}),r),o&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(o):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}Object.setPrototypeOf(u.prototype,HTMLElement.prototype),Object.setPrototypeOf(u,HTMLElement);const f=!1,g=19,v={asc:"arrow_upward",desc:"arrow_downward","asc abs":"\u21e7","desc abs":"\u21e9","col asc":"arrow_back","col desc":"arrow_forward","col asc abs":"\u21e8","col desc abs":"\u21e6"},w=Symbol("Private Datagrid"),b=new WeakMap;let y=[];function x(){const e=y.reduce((e,t)=>e+t,0)/y.length,t=y.length/5,s=1e3/e,i=y.length;console.log("".concat(e.toFixed(2)," ms/frame   ").concat(t," rfps   ").concat(s.toFixed(2)," vfps   (").concat(i," frames in 5s)")),y=[]}function j(e,t,s,i){let o;if(o=t.length>0?t[t.length-1]:"TOTAL",s){let s="";for(let e=0;e<t.length;e++)s+='<span class="pd-tree-group"></span>';e.innerHTML='<div style="display:flex;align-items:stretch">'.concat(s,'<span class="pd-group-name pd-group-leaf">').concat(o,"</span></div>")}else{const s=i?"remove":"add";let r="";for(let e=0;e<t.length;e++)r+='<span class="pd-tree-group"></span>';e.innerHTML='<div style="display:flex;align-items:stretch">'.concat(r,'<span class="pd-row-header-icon">').concat(s,'</span><span class="pd-group-name">').concat(o,"</span></div>")}e.classList.add("pd-group-header")}let z=(m((i=class{constructor(e,t,s){this._column_sizes=e,this._container=t,this.table=s,this.cells=[],this.rows=[]}num_rows(){return this.cells.length}_get_or_create_metadata(e){if(b.has(e))return b.get(e);{const t={};return b.set(e,t),t}}_format(e){const t=Object(n.get_type_config)(e),s=t.type||e,i={float:Intl.NumberFormat,integer:Intl.NumberFormat,datetime:Intl.DateTimeFormat,date:Intl.DateTimeFormat}[s];if(i){const e=new i("en-us",t.format);return{format(t,i){t.textContent=e.format(i),"integer"!==s&&"float"!==s||(i>0?t.classList.add("pd-positive"):i<0&&t.classList.add("pd-negative"))}}}if(void 0===e)return{format:j}}_get_cell(e="td",t,s,i){let o=t[s];return o||(o=t[s]=document.createElement(e),i.appendChild(o)),o}_get_row(e){let t=this.rows[e];t||(t=this.rows[e]=document.createElement("tr"),this.table.appendChild(t));let s=this.cells[e];return s||(s=this.cells[e]=[]),{tr:t,row_container:s}}_clean_columns(e){for(let t=0;t<this.rows.length;t++){const s=this.rows[t],i=this.cells[t];let o=e[t]||e;for(;s.children[o];)s.removeChild(s.children[o]);this.cells[t]=i.slice(0,o)}}_clean_rows(e){for(;this.table.children[e];)this.table.removeChild(this.table.children[e]);this.rows=this.rows.slice(0,e),this.cells=this.cells.slice(0,e)}}).prototype,"_format",[function(e,t,s){const i=new Map,o=s.value;return s.value=function(e){if(i.has(e))return i.get(e);{const t=o.call(this,e);return i.set(e,t),t}},s}],Object.getOwnPropertyDescriptor(i.prototype,"_format"),i.prototype),i);class L extends z{_draw_group_th(e,t,s,i){const{tr:o,row_container:r}=this._get_row(t),n=this._get_cell("th",r,e[t],o),a=e[t];if(e[t]+=1,n.className="",n.removeAttribute("colspan"),n.style.minWidth="0",this._get_or_create_metadata(n).cidx=a,0===(null==i?void 0:i.length))n.innerHTML="<span>"+s+'</span><span class="pd-column-resize"></span>';else{const e=null==i?void 0:i.map(e=>v[e]);n.innerHTML="<span>"+s+'</span><span class="pd-column-header-icon">'.concat(e,'</span><span class="pd-column-resize"></span>')}return n}_redraw_previous(e,t){const{tr:s,row_container:i}=this._get_row(t),o=e[t]-1;if(o<0)return;const r=this._get_cell("th",i,o,s);return r?(r.classList.add("pd-group-header"),r):void 0}_draw_group(e,t,s,i){const o=this._get_or_create_metadata(i);o.column_path=e,o.column_name=t,o.column_type=s,o.is_column_header=!1,o.size_key="".concat(e,"|").concat(s),i.className=""}_draw_th(e,t,s,i){const o=this._get_or_create_metadata(i);o.column_path=e,o.column_name=t,o.column_type=s,o.is_column_header=!0,o.size_key="".concat(e,"|").concat(s);const r=this._column_sizes.auto[o.size_key],n=this._column_sizes.override[o.size_key];i.classList.add(s),n?(i.classList.toggle("pd-cell-clip",r>n),i.style.minWidth=n+"px",i.style.maxWidth=n+"px"):r&&(i.classList.remove("pd-cell-clip"),i.style.maxWidth="none",i.style.minWidth=r+"px")}draw(e,t,s,i,o,{group_header_cache:r=[],offset_cache:n=[]}={}){var a;let l,c,d=null===(a=s.split)||void 0===a?void 0:a.call(s,"|"),_=!1;for(let a=0;a<e;a++)if(c=d[a]?d[a]:"",r[a]=r[a]||[],n[a]=n[a]||0,a<e-1)r[a][0]===c?(l=r[a][1],l.setAttribute("colspan",(parseInt(l.getAttribute("colspan"))||1)+1)):(l=this._draw_group_th(n,a,c,[]),this._draw_group(s,c,i,l),r[a]=[c,l],_=!0);else{_&&this._redraw_previous(n,a);const e=null==o?void 0:o.filter(e=>e[0]===c).map(e=>e[1]);l=this._draw_group_th(n,a,c,e),this._draw_th(t||s,c,i,l)}return 1===e&&void 0===i&&l.classList.add("pd-group-header"),this._clean_rows(n.length),{group_header_cache:r,offset_cache:n,th:l}}clean({offset_cache:e}){this._clean_columns(e)}}function O(e,t){let s=t.split("|");return e[s[s.length-1]]}function k(e,t){if(Array.isArray(e)&&Array.isArray(t)){let s;for(s=0;s<t.length;s++)if(e[s]!==t[s])return 0;return e.length===t.length?2:1}return e===t&&void 0!==e?2:0}class E extends z{_draw_td(e,t,s,i,o,r,n,a,l,c,d){const{tr:_,row_container:h}=this._get_row(e);if(!1!==r){const e=k(o,r);_.classList.toggle("pd-selected",2===e),_.classList.toggle("pd-sub-selected",1===e)}const p=this._get_cell("td",h,t,_),u=this._get_or_create_metadata(p);if(u.id=o,u.cidx=t+d,u.value!==i||u.type!==n){p.className=n,u.column=s,u.size_key="".concat(s,"|").concat(n);const t=this._column_sizes.override[u.size_key];if(t){const e=this._column_sizes.auto[u.size_key];p.classList.toggle("pd-cell-clip",e>t),p.style.minWidth=t+"px",p.style.maxWidth=t+"px"}else p.classList.remove("pd-cell-clip"),p.style.minWidth="0",p.style.maxWidth="none";const o=this._format(n);null==i?(p.textContent="-",u.value=null,u.row_path=null,u.ridx=e+c):o?(o.format(p,i,i.length===a,l),u.value=Array.isArray(i)?i[i.length-1]:i,u.row_path=i,u.ridx=e+c,u.is_open=l):(p.textContent=i,u.value=i,u.ridx=e+c)}return{td:p,metadata:u}}draw(e,t,s,i,o,r,n,a,l,c){var d;let _,h,p=0;for(const d of i){const u=i[p+1],m=null==o?void 0:o[p],f=this._draw_td(p++,s,t,d,m,r,n,a,(null==u?void 0:u.length)>(null==d?void 0:d.length),l,c);if(_=f.td,h=f.metadata,p*g>e)break}this._clean_rows(p);const u=null===(d=_)||void 0===d?void 0:d.offsetWidth;return u&&!this._column_sizes.override[h.size_key]&&(this._column_sizes.auto[h.size_key]=u),{offsetWidth:u,cidx:s,ridx:p}}clean({ridx:e,cidx:t}){this._clean_rows(e),this._clean_columns(t)}}class M{constructor(e,t){const s=document.createElement("table");s.setAttribute("cellspacing",0);const i=document.createElement("thead");s.appendChild(i);const o=document.createElement("tbody");s.appendChild(o),this.table=s,this._column_sizes=t,this.header=new L(t,e,i),this.body=new E(t,e,o),this.fragment=document.createDocumentFragment()}num_columns(){var e;return this.header._get_row(Math.max(0,(null===(e=this.header.rows)||void 0===e?void 0:e.length)-1||0)).row_container.length}async draw(e,t,s,i,o,r,n,a,l,c,d,_){const h=r.slice(_.start_col),p=await e.to_columns(_),{start_col:u}=_;let m,f,g=0,v=0;const w=p.__ID__;"__ROW_PATH__"===r[0]&&(f=this.header.draw(i,n.join(","),""),m=this.body.draw(s,n.join(","),0,p.__ROW_PATH__,w,c,void 0,o,_.start_row,0),c=!1,d||(this._column_sizes.indices[0]=m.offsetWidth),v+=m.offsetWidth,g++);try{for(;g<h.length;){const o=h[g];if(!p[o]){let t=Math.max(_.end_col,0);_.start_col=t,_.end_col=t+1;const s=await e.to_columns(_);o in s||(s[o]=[]),p[o]=s[o]}const r=p[o],n=O(l,o);if(f=this.header.draw(i,void 0,o,n,a,f),m=this.body.draw(s,o,g,r,w,c,n,void 0,_.start_row,u),c=!1,v+=m.offsetWidth||f.th.offsetWidth,d||(this._column_sizes.indices[g+u]=m.offsetWidth||f.th.offsetWidth),g++,v>t)break}}finally{var b;this.body.clean({ridx:(null===(b=m)||void 0===b?void 0:b.ridx)||0,cidx:g}),f&&this.header.clean(f)}}}let W=(m((o=class extends u{constructor(){super(),this._create_shadow_dom()}set_element(e){this.elem=e}get_meta(e){return b.get(e)}get_tds(){return this.table_model.body.cells.flat(1)}get_ths(){return this.table_model.body.cells.flat(1)}clear(){this._sticky_container.innerHTML="<table></table>"}_create_shadow_dom(){this.attachShadow({mode:"open"});const e=document.createElement("style");e.textContent=l.a+d.a,this.shadowRoot.appendChild(e);const t=document.createElement("div");t.classList.add("pd-virtual-panel");const s=document.createElement("div");s.classList.add("pd-scroll-table-clip");const i=document.createElement("div");i.classList.add("pd-scroll-container"),i.appendChild(t),i.appendChild(s),i.addEventListener("scroll",this._on_scroll.bind(this),{passive:!1}),i.addEventListener("mousewheel",this._on_mousewheel.bind(this),{passive:!1});const o=document.createElement("slot");s.appendChild(o),this.shadowRoot.appendChild(i);const r=document.createElement("div");r.style.position="absolute",r.style.visibility="hidden",i.appendChild(r);const n=document.createElement("div");n.addEventListener("mousedown",this._on_click.bind(this)),n.addEventListener("dblclick",this._on_dblclick.bind(this)),this._sticky_container=n,this._table_clip=s,this._table_staging=r,this._scroll_container=i,this._virtual_panel=t}_calculate_row_range(e,t,s){const i=Math.max(1,this._virtual_panel.offsetHeight-e),o=this._scroll_container.scrollTop/i,r=Math.floor(e/g),n=s?this._nrows||0:t;let a=Math.floor(Math.max(0,n+this.table_model.header.cells.length-r)*o),l=a+r;if(l-1>t){const e=l-1-t;a-e<0?(l=t,a=0):(a-=e,l-=e)}return{start_row:a,end_row:l}}_calculate_column_range(e,t,s){const i=Math.max(1,this._virtual_panel.offsetWidth-e),o=this._scroll_container.scrollLeft/i,r=this._max_scroll_column(e,t,s)+.5;let n=Math.floor(r*o);return{start_col:n,end_col:n+(this.table_model.num_columns()||1)+1}}_validate_viewport({start_col:e,end_col:t,start_row:s,end_row:i}){const o=this._start_col!==e,r=this._start_row!==s||this._end_row!==i||this._end_col!==t;return this._start_col=e,this._end_col=t,this._start_row=s,this._end_row=i,{invalid_column:o,invalid_row:r}}_needs_swap(e,t,s){return e||!1}_swap_in(...e){this._needs_swap(...e)?this._table_staging!==this.table_model.table.parentElement&&(this._sticky_container.replaceChild(this.table_model.table.cloneNode(!0),this.table_model.table),this._table_staging.appendChild(this.table_model.table)):this._sticky_container!==this.table_model.table.parentElement&&this._sticky_container.replaceChild(this.table_model.table,this._sticky_container.children[0]),this.elem.dispatchEvent(new CustomEvent("perspective-datagrid-before-update",{detail:this}))}_swap_out(...e){this._needs_swap(...e)&&this._sticky_container.replaceChild(this.table_model.table,this._sticky_container.children[0]),this.elem.dispatchEvent(new CustomEvent("perspective-datagrid-after-update",{detail:this}))}_max_scroll_column(e,t,s){let i=0;t.length>0&&(i=this._column_sizes.indices[0]);let o=s.length;for(;i<e;)o--,i+=this._column_sizes.indices[o]||100;return Math.min(s.length-(t.length>0?2:1),o+(t.length>0?0:1))}_update_virtual_panel_width(e,t,s,i){if(e){const e=Math.max(1,this._virtual_panel.offsetWidth-t),o=this._scroll_container.scrollLeft/e,r=this._max_scroll_column(t,s,i);let n=0,a=0;for(;n<r;)a+=this._column_sizes.indices[n]||100,n++;const l=t+a;this._virtual_panel.style.width=l+"px",this._scroll_container.scrollLeft=o*a}}_update_virtual_panel_height(e){const t=Math.min(1e7,(e+this.table_model.header.cells.length)*g);this._virtual_panel.style.height="".concat(t,"px")}async _on_scroll(e){e.preventDefault(),e.stopPropagation(),e.returnValue=!1,await this.draw(this.view),this.elem.dispatchEvent(new CustomEvent("perspective-datagrid-scroll"))}_on_mousewheel(e){e.preventDefault(),e.returnValue=!1;const t=Math.max(1,this._virtual_panel.offsetHeight-this._scroll_container.offsetHeight),s=Math.max(1,this._virtual_panel.offsetWidth-this._scroll_container.offsetWidth);this._scroll_container.scrollTop=Math.min(t,this._scroll_container.scrollTop+e.deltaY),this._scroll_container.scrollLeft=Math.min(s,this._scroll_container.scrollLeft+e.deltaX),this._on_scroll(e)}_reset_viewport(){this._start_row=void 0,this._end_row=void 0,this._start_col=void 0,this._end_col=void 0}resize(){this._container_width=void 0,this._container_height=void 0,this._nrows=void 0,this._reset_viewport()}reset_scroll(){this._column_sizes.indices=[],this._scroll_container.scrollTop=0,this._scroll_container.scrollLeft=0,this._reset_viewport()}async draw(e,t=!1,s=!1,i=!1){let o;f&&(o=performance.now()),this.config=await e.get_config();const r=this._container_width=this._container_width||this._scroll_container.offsetWidth,n=this._container_height=this._container_height||this._scroll_container.offsetHeight,a=e.num_rows().catch(()=>{}),l=e.column_paths().catch(()=>{}),c=e.schema().catch(()=>{}),d=await a,{start_row:_,end_row:h}=this._calculate_row_range(n,d,s);this._nrows=d,this._update_virtual_panel_height(d);const p=await l;if(void 0===p)return;let{start_col:u,end_col:m}=this._calculate_column_range(r,this.config.row_pivots,p);const g={start_col:u,end_col:m,start_row:_,end_row:h,id:this.config.row_pivots.length>0};let{invalid_row:v,invalid_column:w}=this._validate_viewport(g);if(t||v||w){this._swap_in(t,v,w);const s=this.config.column_pivots.length+1,o=this.config.row_pivots.length,a=await c;await this.table_model.draw(e,r,n,s,o,p,this.config.row_pivots,this.config.sort,a,this._selected_id,i,g),this._swap_out(t,v,w),i||this._update_virtual_panel_width(t||w,r,this.config.row_pivots,p)}f&&y.push(performance.now()-o)}attach(e){this._column_sizes={auto:{},override:{},indices:[]},this.table_model=new M(this._table_clip,this._column_sizes),this._sticky_container.appendChild(this.table_model.table),e&&(this.render_element=e),this.table_model&&(this.render_element?this.render_element!==this.table_model.table.parentElement&&this.render_element.appendChild(this._sticky_container):this.appendChild(this.table_model.table))}async _on_dblclick(e){let t=e.target;for(;"TD"!==t.tagName&&"TH"!==t.tagName;)if(t=t.parentElement,!this._sticky_container.contains(t))return;const s=e.target.classList.contains("pd-column-resize"),i=b.get(t);if(s){await new Promise(setTimeout),this._column_sizes.override[i.size_key]=void 0,this._column_sizes.auto[i.size_key]=void 0,this._column_sizes.indices[i.cidx]=void 0,t.style.minWidth="0",t.style.maxWidth="none";for(const e of this.table_model.body.cells){const t=e[i.cidx];t.style.minWidth="0",t.style.maxWidth="none",t.classList.remove("pd-cell-clip")}await this.draw(this.view,!0,!0)}}async _on_click(e){let t=e.target;for(;"TD"!==t.tagName&&"TH"!==t.tagName;)if(t=t.parentElement,!this._sticky_container.contains(t))return;const s=e.target.classList.contains("pd-row-header-icon"),i=e.target.classList.contains("pd-column-resize"),o=b.get(t);s?await this._on_toggle(e,o):i?this._on_resize_column(e,t,o):(null==o?void 0:o.is_column_header)?await this._on_sort(e,o):await this._on_select(o)}_on_resize_column(e,t,s){const i=e.pageX,o=t.offsetWidth,r=this._scroll_container.scrollLeft,n=e=>this._on_resize_column_move(e,t,i,o,r,s),a=async()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a);const e=this._column_sizes.override[s.size_key];this._column_sizes.indices[s.cidx]=e,await this.draw(this.view,!0,!0)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)}async _on_resize_column_move(e,t,s,i,o,r){await new Promise(setTimeout);const n=e.pageX-s,a=i+n;this._column_sizes.override[r.size_key]=a,t.style.minWidth=a+"px",t.style.maxWidth=a+"px";const l=this._column_sizes.auto[r.size_key];for(const e of this.table_model.body.cells){const t=e[r.cidx];t.style.maxWidth=t.style.minWidth=a+"px",t.classList.toggle("pd-cell-clip",l>a)}n<0&&await this.draw(this.view,!0,!0,!0)}async _on_select(e){if(!this.elem.hasAttribute("selectable"))return;const t=await async function(e,t,s,i){const o=t.row_pivots,r=t.column_pivots,n=s>=0?s:0,a=n+1,l=await e.to_json({start_row:n,end_row:a}),c=l.map(e=>e.__ROW_PATH__)[0]||[],d=o.map((e,t)=>{const s=c[t];return s?[e,"==",s]:void 0}).filter(e=>e),_=o.length>0?i+1:i,h=Object.keys(l[0])[_],p={row:l[0]};let u=[];if(h){const e=h.split("|");p.column_names=[e[e.length-1]],u=r.map((t,s)=>{const i=e[s];return i?[t,"==",i]:void 0}).filter(e=>e).filter(([,,e])=>"__ROW_PATH__"!==e)}const m=t.filter.concat(d).concat(u);return p.config={filters:m},p}(this.view,this.config,e.ridx,e.cidx);2===k(e.id,this._selected_id)?(this._selected_id=void 0,this.elem.dispatchEvent(new CustomEvent("perspective-select",{bubbles:!0,composed:!0,detail:{selected:!1,config:{filters:[]}}}))):(this._selected_id=e.id,this.elem.dispatchEvent(new CustomEvent("perspective-select",{bubbles:!0,composed:!0,detail:h({selected:!0},t)}))),await this.draw(this.view,!0,!0)}async _on_toggle(e,t){t.is_open?e.shiftKey?await this.view.set_depth(t.row_path.length-1):await this.view.collapse(t.ridx):!1===t.is_open&&(e.shiftKey?await this.view.set_depth(t.row_path.length):await this.view.expand(t.ridx)),await this.draw(this.view,!0,!0)}async _on_sort(e,t){let{sort:s}=await this.elem.view.get_config();const i=s.findIndex(e=>e[0]===t.column_name);if(i>-1){const[t,o]=s[i],r=this.elem._increment_sort(o,!1,e.altKey);s[i]=[t,r]}else e.shiftKey?s.push([t.column_name,e.altKey?"asc abs":"asc"]):s=[[t.column_name,e.altKey?"asc abs":"asc"]];this.elem.setAttribute("sort",JSON.stringify(s))}}).prototype,"draw",[r.throttlePromise],Object.getOwnPropertyDescriptor(o.prototype,"draw"),o.prototype),m(o.prototype,"_on_resize_column_move",[r.throttlePromise],Object.getOwnPropertyDescriptor(o.prototype,"_on_resize_column_move"),o.prototype),o);window.customElements.define("perspective-datagrid",W);Object(r.registerPlugin)("datagrid",new class{get name(){return"Datagrid"}get selectMode(){return"toggle"}get deselectMode(){return"pivots"}async update(e,t){try{await e[w].draw(t,!0,!0)}catch(e){return}}async create(e,t){if(!e.hasOwnProperty(w)){const t=document.createElement("style");t.textContent=d.a,document.head.appendChild(t),e[w]=document.createElement("perspective-datagrid"),e[w].set_element(this),e[w].appendChild(document.createElement("slot")),e[w].attach(this),e.innerHTML="",e.appendChild(e[w])}let s=!0;e[w].isConnected||(e.innerHTML="",e[w].clear(),s=!1,e.appendChild(e[w])),e[w].reset_scroll(),e[w].view=t,await e[w].draw(t,s)}async resize(){this.view&&this._datavis[w]&&(this._datavis[w].resize(),await this._datavis[w].draw(this.view))}}),function(){f&&setInterval(x.bind(this),5e3)}()},function(e,t){e.exports=s},function(e,t){e.exports=i},function(e,t){e.exports=o},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t){e.exports=a},function(e,t){e.exports=l},function(e,t){e.exports=c},function(e,t){e.exports=d},function(e,t){e.exports=_}])}));
//# sourceMappingURL=perspective-viewer-datagrid.js.map