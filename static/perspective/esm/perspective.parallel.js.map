{"version":3,"sources":["../../src/js/perspective.parallel.js"],"names":["defaults","get_config","Client","WebSocketClient","require","wasm_worker","wasm","override_config","INLINE_WARNING","override","_fetch","url","Promise","resolve","wasmXHR","XMLHttpRequest","open","responseType","onload","response","send","worker","ArrayBuffer","console","warn","_wasm","WebWorkerClient","constructor","config","register","_worker","msg","cmd","WebAssembly","Error","buffer","all","key","addEventListener","_handle","bind","postMessage","_detect_transferable","transferable","args","terminate","undefined","ab","byteLength","log","WORKER_SINGLETON","__WORKER__","__CONFIG__","getInstance","config_str","JSON","stringify","document","currentScript","hasAttribute","mod","x","set","websocket","window","location","origin","replace","WebSocket","shared_worker","prop","Object","keys"],"mappings":"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","sourcesContent":["/******************************************************************************\r\n *\r\n * Copyright (c) 2017, the Perspective Authors.\r\n *\r\n * This file is part of the Perspective library, distributed under the terms of\r\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\r\n *\r\n */\r\n\r\nimport * as defaults from \"./config/constants.js\";\r\nimport {get_config} from \"./config\";\r\nimport {Client} from \"./api/client.js\";\r\nconst {WebSocketClient} = require(\"./websocket\");\r\n\r\nimport wasm_worker from \"./perspective.wasm.js\";\r\nimport wasm from \"./psp.async.wasm.js\";\r\nimport {override_config} from \"../../dist/esm/config/index.js\";\r\n\r\n// eslint-disable-next-line max-len\r\nconst INLINE_WARNING = `Perspective has been compiled in INLINE mode.  While Perspective's runtime performance is not affected, you may see smaller assets size and faster engine initial load time using \"@finos/perspective-webpack-plugin\" to build your application.\r\n\r\nhttps://perspective.finos.org/docs/md/installation.html#-an-important-note-about-hosting`;\r\n\r\n/**\r\n * Singleton WASM file download cache.\r\n */\r\nconst override = new (class {\r\n    _fetch(url) {\r\n        return new Promise(resolve => {\r\n            let wasmXHR = new XMLHttpRequest();\r\n            wasmXHR.open(\"GET\", url, true);\r\n            wasmXHR.responseType = \"arraybuffer\";\r\n            wasmXHR.onload = () => {\r\n                resolve(wasmXHR.response);\r\n            };\r\n            wasmXHR.send(null);\r\n        });\r\n    }\r\n\r\n    worker() {\r\n        return wasm_worker();\r\n    }\r\n\r\n    async wasm() {\r\n        if (wasm instanceof ArrayBuffer) {\r\n            console.warn(INLINE_WARNING);\r\n            this._wasm = wasm;\r\n        } else {\r\n            this._wasm = await this._fetch(wasm);\r\n        }\r\n        return this._wasm;\r\n    }\r\n})();\r\n\r\n/**\r\n * WebWorker extends Perspective's `worker` class and defines interactions using\r\n * the WebWorker API.\r\n *\r\n * This class serves as the client API for transporting messages to/from Web\r\n * Workers.\r\n */\r\nclass WebWorkerClient extends Client {\r\n    constructor(config) {\r\n        if (config) {\r\n            override_config(config);\r\n        }\r\n        super();\r\n        this.register();\r\n    }\r\n\r\n    /**\r\n     * When the worker is created, load either the ASM or WASM bundle depending\r\n     * on WebAssembly compatibility.  Don't use transferrable so multiple\r\n     * workers can be instantiated.\r\n     */\r\n    async register() {\r\n        let _worker;\r\n        const msg = {cmd: \"init\", config: get_config()};\r\n        if (typeof WebAssembly === \"undefined\") {\r\n            throw new Error(\"WebAssembly not supported. Support for ASM.JS has been removed as of 0.3.1.\");\r\n        } else {\r\n            [_worker, msg.buffer] = await Promise.all([override.worker(), override.wasm()]);\r\n        }\r\n        for (var key in this._worker) {\r\n            _worker[key] = this._worker[key];\r\n        }\r\n        this._worker = _worker;\r\n        this._worker.addEventListener(\"message\", this._handle.bind(this));\r\n        this._worker.postMessage(msg);\r\n        this._detect_transferable();\r\n    }\r\n\r\n    /**\r\n     * Send a message from the worker, using transferables if necessary.\r\n     *\r\n     * @param {*} msg\r\n     */\r\n    send(msg) {\r\n        if (this._worker.transferable && msg.args && msg.args[0] instanceof ArrayBuffer) {\r\n            this._worker.postMessage(msg, msg.args);\r\n        } else {\r\n            this._worker.postMessage(msg);\r\n        }\r\n    }\r\n\r\n    terminate() {\r\n        this._worker.terminate();\r\n        this._worker = undefined;\r\n    }\r\n\r\n    _detect_transferable() {\r\n        var ab = new ArrayBuffer(1);\r\n        this._worker.postMessage(ab, [ab]);\r\n        this._worker.transferable = ab.byteLength === 0;\r\n        if (!this._worker.transferable) {\r\n            console.warn(\"Transferable support not detected\");\r\n        } else {\r\n            console.log(\"Transferable support detected\");\r\n        }\r\n    }\r\n}\r\n\r\n/******************************************************************************\r\n *\r\n * Web Worker Singleton\r\n *\r\n */\r\n\r\nconst WORKER_SINGLETON = (function() {\r\n    let __WORKER__, __CONFIG__;\r\n    return {\r\n        getInstance: function(config) {\r\n            if (__WORKER__ === undefined) {\r\n                __WORKER__ = new WebWorkerClient(config);\r\n            }\r\n            const config_str = JSON.stringify(config);\r\n            if (__CONFIG__ && config_str !== __CONFIG__) {\r\n                throw new Error(`Confiuration object for shared_worker() has changed - this is probably a bug in your application.`);\r\n            }\r\n            __CONFIG__ = config_str;\r\n            return __WORKER__;\r\n        }\r\n    };\r\n})();\r\n\r\n/**\r\n * If Perspective is loaded with the `preload` attribute, pre-initialize the\r\n * worker so it is available at page render.\r\n */\r\nif (document.currentScript && document.currentScript.hasAttribute(\"preload\")) {\r\n    WORKER_SINGLETON.getInstance();\r\n}\r\n\r\nconst mod = {\r\n    override: x => override.set(x),\r\n\r\n    /**\r\n     * Create a new WebWorkerClient instance. s\r\n     * @param {*} [config] An optional perspective config object override\r\n     */\r\n    worker(config) {\r\n        return new WebWorkerClient(config);\r\n    },\r\n\r\n    /**\r\n     * Create a new WebSocketClient instance. The `url` parameter is provided,\r\n     * load the worker at `url` using a WebSocket. s\r\n     * @param {*} url Defaults to `window.location.origin`\r\n     * @param {*} [config] An optional perspective config object override\r\n     */\r\n    websocket(url = window.location.origin.replace(\"http\", \"ws\")) {\r\n        return new WebSocketClient(new WebSocket(url));\r\n    },\r\n\r\n    shared_worker(config) {\r\n        return WORKER_SINGLETON.getInstance(config);\r\n    }\r\n};\r\n\r\nfor (let prop of Object.keys(defaults)) {\r\n    mod[prop] = defaults[prop];\r\n}\r\n\r\nexport default mod;\r\n"],"file":"perspective.parallel.js"}