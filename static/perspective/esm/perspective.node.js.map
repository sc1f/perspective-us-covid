{"version":3,"sources":["../../src/js/perspective.node.js"],"names":["Client","require","Server","WebSocketManager","WebSocketClient","perspective","default","fs","http","WebSocket","process","path","load_perspective","LOCAL_PATH","join","cwd","buffer","SYNC_SERVER","init","msg","wasmBinary","wasmJSMethod","then","core","post","SYNC_CLIENT","_handle","data","send","id","cmd","module","exports","sync_module","DEFAULT_ASSETS","CONTENT_TYPES","read_promise","filePath","Promise","resolve","reject","readFile","error","content","code","perspective_assets","assets","host_psp","request","response","setHeader","url","split","extname","contentType","rootDir","console","log","writeHead","end","paths","map","x","e","indexOf","WebSocketServer","constructor","port","on_start","_server","createServer","_wss","noServer","perMessageDeflate","on","ws","add_connection","socket","head","handleUpgrade","sock","emit","listen","address","close","websocket"],"mappings":"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","sourcesContent":["/******************************************************************************\r\n *\r\n * Copyright (c) 2017, the Perspective Authors.\r\n *\r\n * This file is part of the Perspective library, distributed under the terms of\r\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\r\n *\r\n */\r\n\r\nconst {Client} = require(\"./api/client.js\");\r\nconst {Server} = require(\"./api/server.js\");\r\nconst {WebSocketManager, WebSocketClient} = require(\"./websocket\");\r\n\r\nconst perspective = require(\"./perspective.js\").default;\r\n\r\nconst fs = require(\"fs\");\r\nconst http = require(\"http\");\r\nconst WebSocket = require(\"ws\");\r\nconst process = require(\"process\");\r\n\r\nconst path = require(\"path\");\r\n\r\nconst load_perspective = require(\"./psp.async.js\").default;\r\n\r\n// eslint-disable-next-line no-undef\r\n\r\nconst LOCAL_PATH = path.join(process.cwd(), \"node_modules\");\r\nconst buffer = require(\"./psp.async.wasm.js\").default;\r\n\r\nconst SYNC_SERVER = new (class extends Server {\r\n    init(msg) {\r\n        load_perspective({\r\n            wasmBinary: buffer,\r\n            wasmJSMethod: \"native-wasm\"\r\n        }).then(core => {\r\n            this.perspective = perspective(core);\r\n            super.init(msg);\r\n        });\r\n    }\r\n\r\n    post(msg) {\r\n        SYNC_CLIENT._handle({data: msg});\r\n    }\r\n})();\r\n\r\nconst SYNC_CLIENT = new (class extends Client {\r\n    send(msg) {\r\n        SYNC_SERVER.process(msg);\r\n    }\r\n})();\r\n\r\nSYNC_CLIENT.send({id: -1, cmd: \"init\"});\r\n\r\nmodule.exports = SYNC_CLIENT;\r\nmodule.exports.sync_module = () => SYNC_SERVER.perspective;\r\n\r\nconst DEFAULT_ASSETS = [\r\n    \"@finos/perspective/dist/umd\",\r\n    \"@finos/perspective-bench/dist\",\r\n    \"@finos/perspective-viewer/dist/umd\",\r\n    \"@finos/perspective-viewer-highcharts/dist/umd\",\r\n    \"@finos/perspective-viewer-hypergrid/dist/umd\",\r\n    \"@finos/perspective-viewer-datagrid/dist/umd\",\r\n    \"@finos/perspective-viewer-d3fc/dist/umd\",\r\n    \"@finos/perspective-workspace/dist/umd\"\r\n];\r\n\r\nconst CONTENT_TYPES = {\r\n    \".js\": \"text/javascript\",\r\n    \".css\": \"text/css\",\r\n    \".json\": \"application/json\",\r\n    \".arrow\": \"arraybuffer\",\r\n    \".wasm\": \"application/wasm\"\r\n};\r\n\r\nfunction read_promise(filePath) {\r\n    return new Promise((resolve, reject) => {\r\n        fs.readFile(filePath, function(error, content) {\r\n            if (error && error.code !== \"ENOENT\") {\r\n                reject(error);\r\n            } else {\r\n                resolve(content);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Host a Perspective server that hosts data, code files, etc.\r\n */\r\nfunction perspective_assets(assets, host_psp) {\r\n    return async function(request, response) {\r\n        response.setHeader(\"Access-Control-Allow-Origin\", \"*\");\r\n        response.setHeader(\"Access-Control-Request-Method\", \"*\");\r\n        response.setHeader(\"Access-Control-Allow-Methods\", \"OPTIONS,GET\");\r\n        response.setHeader(\"Access-Control-Allow-Headers\", \"*\");\r\n        let url = request.url.split(/[\\?\\#]/)[0];\r\n        if (url === \"/\") {\r\n            url = \"/index.html\";\r\n        }\r\n        let extname = path.extname(url);\r\n        let contentType = CONTENT_TYPES[extname] || \"text/html\";\r\n        try {\r\n            for (let rootDir of assets) {\r\n                let filePath = rootDir + url;\r\n                let content = await read_promise(filePath);\r\n                if (typeof content !== \"undefined\") {\r\n                    console.log(`200 ${url}`);\r\n                    response.writeHead(200, {\"Content-Type\": contentType});\r\n                    response.end(content, extname === \".arrow\" ? \"user-defined\" : \"utf-8\");\r\n                    return;\r\n                }\r\n            }\r\n            if (host_psp || typeof host_psp === \"undefined\") {\r\n                for (let rootDir of DEFAULT_ASSETS) {\r\n                    try {\r\n                        let paths = require.resolve.paths(rootDir + url);\r\n                        paths = [...paths, ...assets.map(x => path.join(x, \"node_modules\")), LOCAL_PATH];\r\n                        let filePath = require.resolve(rootDir + url, {paths});\r\n                        let content = await read_promise(filePath);\r\n                        if (typeof content !== \"undefined\") {\r\n                            console.log(`200 ${url}`);\r\n                            response.writeHead(200, {\"Content-Type\": contentType});\r\n                            response.end(content, extname === \".arrow\" ? \"user-defined\" : \"utf-8\");\r\n                            return;\r\n                        }\r\n                    } catch (e) {}\r\n                }\r\n            }\r\n            if (url.indexOf(\"favicon.ico\") > -1) {\r\n                response.writeHead(200);\r\n                response.end(\"\", \"utf-8\");\r\n            } else {\r\n                console.error(`404 ${url}`);\r\n                response.writeHead(404);\r\n                response.end(\"\", \"utf-8\");\r\n            }\r\n        } catch (error) {\r\n            if (error.code !== \"ENOENT\") {\r\n                console.error(`500 ${url}`);\r\n                response.writeHead(500);\r\n                response.end(\"\", \"utf-8\");\r\n            }\r\n        }\r\n    };\r\n}\r\n\r\nclass WebSocketServer extends WebSocketManager {\r\n    constructor({assets, host_psp, port, on_start} = {}) {\r\n        super();\r\n        port = typeof port === \"undefined\" ? 8080 : port;\r\n        assets = assets || [\"./\"];\r\n\r\n        // Serve Perspective files through HTTP\r\n        this._server = http.createServer(perspective_assets(assets, host_psp));\r\n\r\n        // Serve Worker API through WebSockets\r\n        this._wss = new WebSocket.Server({noServer: true, perMessageDeflate: true});\r\n\r\n        // When the server starts, define how to handle messages\r\n        this._wss.on(\"connection\", ws => this.add_connection(ws));\r\n\r\n        this._server.on(\"upgrade\", (request, socket, head) => {\r\n            console.log(\"200    *** websocket upgrade ***\");\r\n            this._wss.handleUpgrade(request, socket, head, sock => this._wss.emit(\"connection\", sock, request));\r\n        });\r\n\r\n        this._server.listen(port, () => {\r\n            console.log(`Listening on port ${this._server.address().port}`);\r\n            if (on_start) {\r\n                on_start();\r\n            }\r\n        });\r\n    }\r\n\r\n    close() {\r\n        this._server.close();\r\n    }\r\n}\r\n\r\nconst websocket = url => {\r\n    return new WebSocketClient(new WebSocket(url));\r\n};\r\n\r\nmodule.exports.websocket = websocket;\r\nmodule.exports.perspective_assets = perspective_assets;\r\nmodule.exports.WebSocketServer = WebSocketServer;\r\nmodule.exports.WebSocketManager = WebSocketManager;\r\n"],"file":"perspective.node.js"}