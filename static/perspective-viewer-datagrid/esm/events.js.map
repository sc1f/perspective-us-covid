{"version":3,"sources":["../../src/js/events.js"],"names":["throttlePromise","isEqual","METADATA_MAP","DatagridVirtualTableViewModel","getCellConfig","DatagridViewEventModel","register_listeners","_scroll_container","addEventListener","_on_scroll","bind","passive","_on_mousewheel","_sticky_container","_on_click","_on_dblclick","event","stopPropagation","returnValue","draw","_render_element","dispatchEvent","CustomEvent","_virtual_scrolling_disabled","preventDefault","offsetWidth","offsetHeight","scrollTop","scrollLeft","total_scroll_height","Math","max","_virtual_panel","total_scroll_width","min","deltaY","deltaX","element","target","tagName","parentElement","contains","is_resize","classList","metadata","get","Promise","setTimeout","_column_sizes","override","size_key","auto","indices","cidx","style","minWidth","maxWidth","row","table_model","body","cells","td","remove","invalid_viewport","is_button","_on_toggle","_on_resize_column","is_column_header","_on_sort","_on_select","start","pageX","width","move","_on_resize_column_move","up","document","removeEventListener","override_width","th","diff","auto_width","toggle","preserve_width","hasAttribute","is_deselect","id","_selected_id","filters","undefined","_view_cache","ridx","config","bubbles","composed","detail","selected","is_open","shiftKey","view","set_depth","row_path","length","collapse","expand","sort","slice","current_idx","findIndex","x","column_name","sort_dir","new_sort","_increment_sort","altKey","push","setAttribute","JSON","stringify"],"mappings":"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","sourcesContent":["/******************************************************************************\r\n *\r\n * Copyright (c) 2017, the Perspective Authors.\r\n *\r\n * This file is part of the Perspective library, distributed under the terms of\r\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\r\n *\r\n */\r\n\r\nimport {throttlePromise} from \"@finos/perspective-viewer/dist/esm/utils.js\";\r\n\r\nimport isEqual from \"lodash/isEqual\";\r\nimport {METADATA_MAP} from \"./constants\";\r\nimport {DatagridVirtualTableViewModel} from \"./scroll_panel\";\r\nimport {getCellConfig} from \"./utils\";\r\n\r\n/**\r\n *\r\n *\r\n * @class DatagridViewEventModel\r\n * @extends {DatagridVirtualTableViewModel}\r\n */\r\nexport class DatagridViewEventModel extends DatagridVirtualTableViewModel {\r\n    register_listeners() {\r\n        this._scroll_container.addEventListener(\"scroll\", this._on_scroll.bind(this), {passive: false});\r\n        this._scroll_container.addEventListener(\"mousewheel\", this._on_mousewheel.bind(this), {passive: false});\r\n        this._sticky_container.addEventListener(\"mousedown\", this._on_click.bind(this));\r\n        this._sticky_container.addEventListener(\"dblclick\", this._on_dblclick.bind(this));\r\n    }\r\n\r\n    /**\r\n     * @returns\r\n     * @memberof DatagridViewModel\r\n     */\r\n    async _on_scroll(event) {\r\n        event.stopPropagation();\r\n        event.returnValue = false;\r\n        await this.draw();\r\n        this._render_element.dispatchEvent(new CustomEvent(\"perspective-datagrid-scroll\"));\r\n    }\r\n\r\n    /**\r\n     * Mousewheel must precalculate in addition to `_on_scroll` to prevent\r\n     * visual artifacts due to scrolling \"inertia\" on modern browsers/mobile.\r\n     *\r\n     * @param {*} event\r\n     * @memberof DatagridViewModel\r\n     */\r\n    _on_mousewheel(event) {\r\n        if (this._virtual_scrolling_disabled) {\r\n            return;\r\n        }\r\n        event.preventDefault();\r\n        event.returnValue = false;\r\n        const {offsetWidth, offsetHeight, scrollTop, scrollLeft} = this._scroll_container;\r\n        const total_scroll_height = Math.max(1, this._virtual_panel.offsetHeight - offsetHeight);\r\n        const total_scroll_width = Math.max(1, this._virtual_panel.offsetWidth - offsetWidth);\r\n        this._scroll_container.scrollTop = Math.min(total_scroll_height, scrollTop + event.deltaY);\r\n        this._scroll_container.scrollLeft = Math.min(total_scroll_width, scrollLeft + event.deltaX);\r\n        this._on_scroll(event);\r\n    }\r\n\r\n    /**\r\n     * Handles double-click header width override reset.\r\n     *\r\n     * @param {*} event\r\n     * @returns\r\n     * @memberof DatagridVirtualTableViewModel\r\n     */\r\n    async _on_dblclick(event) {\r\n        let element = event.target;\r\n        while (element.tagName !== \"TD\" && element.tagName !== \"TH\") {\r\n            element = element.parentElement;\r\n            if (!this._sticky_container.contains(element)) {\r\n                return;\r\n            }\r\n        }\r\n        const is_resize = event.target.classList.contains(\"pd-column-resize\");\r\n        const metadata = METADATA_MAP.get(element);\r\n        if (is_resize) {\r\n            await new Promise(setTimeout);\r\n            delete this._column_sizes.override[metadata.size_key];\r\n            delete this._column_sizes.auto[metadata.size_key];\r\n            delete this._column_sizes.indices[metadata.cidx];\r\n            element.style.minWidth = \"0\";\r\n            element.style.maxWidth = \"none\";\r\n            for (const row of this.table_model.body.cells) {\r\n                const td = row[metadata.cidx];\r\n                td.style.minWidth = \"0\";\r\n                td.style.maxWidth = \"none\";\r\n                td.classList.remove(\"pd-cell-clip\");\r\n            }\r\n            await this.draw({invalid_viewport: true});\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Dispatches all click events to other handlers, depending on\r\n     * `event.target`.\r\n     *\r\n     * @param {*} event\r\n     * @returns\r\n     * @memberof DatagridVirtualTableViewModel\r\n     */\r\n    async _on_click(event) {\r\n        let element = event.target;\r\n        while (element.tagName !== \"TD\" && element.tagName !== \"TH\") {\r\n            element = element.parentElement;\r\n            if (!this._sticky_container.contains(element)) {\r\n                return;\r\n            }\r\n        }\r\n        const is_button = event.target.classList.contains(\"pd-row-header-icon\");\r\n        const is_resize = event.target.classList.contains(\"pd-column-resize\");\r\n        const metadata = METADATA_MAP.get(element);\r\n        if (is_button) {\r\n            await this._on_toggle(event, metadata);\r\n        } else if (is_resize) {\r\n            this._on_resize_column(event, element, metadata);\r\n        } else if (metadata?.is_column_header) {\r\n            await this._on_sort(event, metadata);\r\n        } else {\r\n            await this._on_select(metadata);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Datagrid event for column resize.\r\n     *\r\n     * @param {*} event\r\n     * @param {*} element\r\n     * @param {*} metadata\r\n     * @memberof DatagridVirtualTableViewModel\r\n     */\r\n    _on_resize_column(event, element, metadata) {\r\n        const start = event.pageX;\r\n        const width = element.offsetWidth;\r\n        const move = event => this._on_resize_column_move(event, element, start, width, metadata);\r\n        const up = async () => {\r\n            document.removeEventListener(\"mousemove\", move);\r\n            document.removeEventListener(\"mouseup\", up);\r\n            const override_width = this._column_sizes.override[metadata.size_key];\r\n            this._column_sizes.indices[metadata.cidx] = override_width;\r\n            await this.draw({invalid_viewport: true});\r\n        };\r\n        document.addEventListener(\"mousemove\", move);\r\n        document.addEventListener(\"mouseup\", up);\r\n    }\r\n\r\n    /**\r\n     * Datagrid event for mouse movement when resizing a column.\r\n     *\r\n     * @param {*} event\r\n     * @param {*} th\r\n     * @param {*} start\r\n     * @param {*} width\r\n     * @param {*} metadata\r\n     * @memberof DatagridVirtualTableViewModel\r\n     */\r\n    @throttlePromise\r\n    async _on_resize_column_move(event, th, start, width, metadata) {\r\n        await new Promise(setTimeout);\r\n        const diff = event.pageX - start;\r\n        const override_width = width + diff;\r\n        this._column_sizes.override[metadata.size_key] = override_width;\r\n        th.style.minWidth = override_width + \"px\";\r\n        th.style.maxWidth = override_width + \"px\";\r\n        const auto_width = this._column_sizes.auto[metadata.size_key];\r\n        for (const row of this.table_model.body.cells) {\r\n            const td = row[metadata.cidx];\r\n            td.style.maxWidth = td.style.minWidth = override_width + \"px\";\r\n            td.classList.toggle(\"pd-cell-clip\", auto_width > override_width);\r\n        }\r\n\r\n        if (diff < 0) {\r\n            await this.draw({invalid_viewport: true, preserve_width: true});\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Datagrid event which handles row selection.\r\n     *\r\n     * @param {*} metadata\r\n     * @returns\r\n     * @memberof DatagridVirtualTableViewModel\r\n     */\r\n    async _on_select(metadata) {\r\n        if (!this._render_element.hasAttribute(\"selectable\")) {\r\n            return;\r\n        }\r\n\r\n        const is_deselect = isEqual(metadata.id, this._selected_id);\r\n        let filters = [];\r\n        if (is_deselect) {\r\n            this._selected_id = undefined;\r\n            await this.draw({invalid_viewport: true});\r\n        } else {\r\n            this._selected_id = metadata.id;\r\n            await this.draw({invalid_viewport: true});\r\n            filters = await getCellConfig(this._view_cache, metadata.ridx, metadata.cidx);\r\n            filters = filters.config.filters;\r\n        }\r\n\r\n        this._render_element.dispatchEvent(\r\n            new CustomEvent(\"perspective-select\", {\r\n                bubbles: true,\r\n                composed: true,\r\n                detail: {\r\n                    selected: !is_deselect,\r\n                    config: {filters}\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Toggles a tree row between 'open' and 'closed' states, or toggles all\r\n     * tree rows at this depth when the shift key is also pressed.\r\n     *\r\n     * @param {*} event\r\n     * @param {*} metadata\r\n     * @memberof DatagridVirtualTableViewModel\r\n     */\r\n    async _on_toggle(event, metadata) {\r\n        if (metadata.is_open) {\r\n            if (event.shiftKey) {\r\n                await this._view_cache.view.set_depth(metadata.row_path.length - 1);\r\n            } else {\r\n                await this._view_cache.view.collapse(metadata.ridx);\r\n            }\r\n        } else if (metadata.is_open === false) {\r\n            if (event.shiftKey) {\r\n                await this._view_cache.view.set_depth(metadata.row_path.length);\r\n            } else {\r\n                await this._view_cache.view.expand(metadata.ridx);\r\n            }\r\n        }\r\n        await this.draw({invalid_viewport: true});\r\n    }\r\n\r\n    /**\r\n     * Datagrid event which handles sorting.  There are 3 control states:\r\n     *\r\n     *  - Already sorted by `metadata.column_name`, increment sort clause to\r\n     *    next sort state.\r\n     *  - Not sorted, shift key, append new sort clause to existing.\r\n     *  - Not sorted, set as new sort clause.\r\n     *\r\n     * @param {*} event\r\n     * @param {*} metadata\r\n     * @memberof DatagridVirtualTableViewModel\r\n     */\r\n    async _on_sort(event, metadata) {\r\n        let sort = this._view_cache.config.sort.slice();\r\n        const current_idx = sort.findIndex(x => x[0] === metadata.column_name);\r\n        if (current_idx > -1) {\r\n            const sort_dir = sort[current_idx][1];\r\n            const new_sort = this._render_element._increment_sort(sort_dir, false, event.altKey);\r\n            sort[current_idx] = [metadata.column_name, new_sort];\r\n        } else {\r\n            let sort_dir = event.altKey ? \"asc abs\" : \"asc\";\r\n            const new_sort = [metadata.column_name, sort_dir];\r\n            if (event.shiftKey) {\r\n                sort.push(new_sort);\r\n            } else {\r\n                sort = [new_sort];\r\n            }\r\n        }\r\n        this._render_element.setAttribute(\"sort\", JSON.stringify(sort));\r\n    }\r\n}\r\n"],"file":"events.js"}