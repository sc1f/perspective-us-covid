!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("core-js/modules/web.dom-collections.iterator"),require("lodash/isEqual"),require("@finos/perspective-viewer/dist/esm/utils.js"),require("@finos/perspective/dist/esm/config"),require("core-js/modules/es.array.unscopables.flat")):"function"==typeof define&&define.amd?define(["core-js/modules/web.dom-collections.iterator","lodash/isEqual","@finos/perspective-viewer/dist/esm/utils.js","@finos/perspective/dist/esm/config","core-js/modules/es.array.unscopables.flat"],t):"object"==typeof exports?exports["perspective-viewer-datagrid"]=t(require("core-js/modules/web.dom-collections.iterator"),require("lodash/isEqual"),require("@finos/perspective-viewer/dist/esm/utils.js"),require("@finos/perspective/dist/esm/config"),require("core-js/modules/es.array.unscopables.flat")):e["perspective-viewer-datagrid"]=t(e["core-js/modules/web.dom-collections.iterator"],e["lodash/isEqual"],e["@finos/perspective-viewer/dist/esm/utils.js"],e["@finos/perspective/dist/esm/config"],e["core-js/modules/es.array.unscopables.flat"])}(window,(function(e,t,i,s,o){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(s,o,function(t){return e[t]}.bind(null,o));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=8)}([function(t,i){t.exports=e},function(e,i){e.exports=t},function(e,t){e.exports=i},function(e,t,i){(e.exports=i(6)(!1)).push([e.i,'perspective-viewer>div{position:absolute;overflow:hidden;top:12px;left:12px;right:12px;bottom:12px}:host th,perspective-viewer th{text-align:center;position:relative}:host thead tr:not(:last-child) th,perspective-viewer thead tr:not(:last-child) th{overflow:hidden;max-width:0}:host tbody .pd-float,:host thead tr:last-child .pd-float,perspective-viewer tbody .pd-float,perspective-viewer thead tr:last-child .pd-float{text-align:right}:host tbody .pd-integer,:host thead .pd-integer,perspective-viewer tbody .pd-integer,perspective-viewer thead .pd-integer{text-align:right}:host .pd-positive,perspective-viewer .pd-positive{color:#1078d1}:host .pd-negative,perspective-viewer .pd-negative{color:#de3838}:host span.pd-tree-container,perspective-viewer span.pd-tree-container{display:flex;align-items:center;height:100%}:host tbody .pd-date,:host tbody .pd-datetime,:host tbody .pd-string,:host thead .pd-date,:host thead .pd-datetime,:host thead .pd-string,perspective-viewer tbody .pd-date,perspective-viewer tbody .pd-datetime,perspective-viewer tbody .pd-string,perspective-viewer thead .pd-date,perspective-viewer thead .pd-datetime,perspective-viewer thead .pd-string{text-align:left}:host tr td.pd-group-header,:host tr th,perspective-viewer tr td.pd-group-header,perspective-viewer tr th{border-right:1px solid #ddd}:host tr th:last-child,:host tr:last-child th:not(.pd-group-header),perspective-viewer tr th:last-child,perspective-viewer tr:last-child th:not(.pd-group-header){border-right:none}:host tr:last-child th,perspective-viewer tr:last-child th{border-bottom:1px solid #ddd}:host tr td span.pd-tree-group,perspective-viewer tr td span.pd-tree-group{margin-left:5px;margin-right:15px;border-left:1px solid #eee;height:100%}:host td,:host th,perspective-viewer td,perspective-viewer th{white-space:nowrap;font-size:12px;height:19px;padding:0 5px}:host tbody,perspective-viewer tbody{transition:opacity .2s ease-in}:host tbody:hover tr:hover td,perspective-viewer tbody:hover tr:hover td{background:#eee;opacity:1}:host table tr:hover,perspective-viewer table tr:hover{color:#333}:host tr,perspective-viewer tr{transition:background-color .2s ease-in,color .2s ease-in}:host table *,perspective-viewer table *{box-sizing:border-box}:host table,perspective-viewer table{position:absolute;overflow:hidden;color:#666}:host span.pd-row-header-icon,perspective-viewer span.pd-row-header-icon{color:#aaa;padding-right:4px;font-family:"Material Icons"}:host span.pd-column-header-icon,perspective-viewer span.pd-column-header-icon{font-size:10px;padding-left:3px;display:inline-block;width:10px;font-family:"Material Icons"}:host span.pd-row-header-icon:hover,perspective-viewer span.pd-row-header-icon:hover{color:#1a7da1;text-shadow:0 0 3px #1a7da1}:host .pd-selected td,perspective-viewer .pd-selected td{background-color:#eee}:host .pd-cell-clip,perspective-viewer .pd-cell-clip{overflow:hidden;text-overflow:ellipsis}:host td span.pd-group-name,:host th span.pd-group-name,perspective-viewer td span.pd-group-name,perspective-viewer th span.pd-group-name{margin-right:-5px;padding-right:5px;padding-left:8px;flex:1;height:100%}:host td span.pd-group-leaf,perspective-viewer td span.pd-group-leaf{margin-left:12px;height:100%}:host .pd-column-resize,perspective-viewer .pd-column-resize{height:100%;width:10px;position:absolute;top:0;right:0;cursor:col-resize}',""])},function(e,t){e.exports=s},function(e,t){e.exports=o},function(e,t){e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var i=function(e,t){var i=e[1]||"",s=e[3];if(!s)return i;if(t&&"function"==typeof btoa){var o=(n=s,"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(n))))+" */"),r=s.sources.map((function(e){return"/*# sourceURL="+s.sourceRoot+e+" */"}));return[i].concat(r).concat([o]).join("\n")}var n;return[i].join("\n")}(t,e);return t[2]?"@media "+t[2]+"{"+i+"}":i})).join("")},t.i=function(e,i){"string"==typeof e&&(e=[[null,e,""]]);for(var s={},o=0;o<this.length;o++){var r=this[o][0];"number"==typeof r&&(s[r]=!0)}for(o=0;o<e.length;o++){var n=e[o];"number"==typeof n[0]&&s[n[0]]||(i&&!n[2]?n[2]=i:i&&(n[2]="("+n[2]+") and ("+i+")"),t.push(n))}},t}},function(e,t,i){(e.exports=i(6)(!1)).push([e.i,"div.pd-scroll-container{position:absolute;top:0;left:0;right:0;bottom:0;overflow:auto;-webkit-overflow-scrolling:auto}div.pd-virtual-panel{position:absolute;top:0;left:0;right:0;pointer-events:none}div.pd-scroll-table-clip{position:sticky;position:-webkit-sticky;top:0;left:0;overflow:hidden;width:100%;height:100%}div.pd-tree-container{display:flex;align-items:center;height:100%}slot{position:absolute;overflow:hidden}",""])},function(e,t,i){"use strict";i.r(t);var s=i(2);i(5),i(0);const o=new WeakMap,r=new WeakMap,n=!1,a={asc:"arrow_upward",desc:"arrow_downward","asc abs":"\u21e7","desc abs":"\u21e9","col asc":"arrow_back","col desc":"arrow_forward","col asc abs":"\u21e8","col desc abs":"\u21e6"};let l=[];function c(){const e=l.reduce((e,t)=>e+t,0)/l.length,t=l.length/5,i=1e3/e,s=l.length;console.log(`${e.toFixed(2)} ms/frame   ${t} rfps   ${i.toFixed(2)} vfps   (${s} frames in 5s)`),l=[]}function _(e,t,i){const s=new Map,o=i.value;return i.value=function(e){if(s.has(e))return s.get(e);{const t=o.call(this,e);return s.set(e,t),t}},i}function d(e,t){let i=t.split("|");return e[i[i.length-1]]}const h=(e,...t)=>e.map((e,i)=>[e,t[i]]).flat().filter(e=>!!e).join("");var p,u=i(4);function v(e,t,i){const s=this._format_class(t)(e),o=["pd-group-name"];return i&&o.push("pd-group-leaf"),s&&o.push(s),o.join(" ")}function m(e,t,i,s,o){const r=i[t.length-1],n=0===t.length?"TOTAL":t[t.length-1],a=v.call(this,n,r,s),l=function(e,t,i){const s=e.map(()=>'<span class="pd-tree-group"></span>');if(!i){const e=`<span class="pd-row-header-icon">${t?"remove":"add"}</span>`;s.push(e)}return s.join("")}(t,o,s),c=this._format_text(r)(n);e.classList.add("pd-group-header"),e.innerHTML=h` <span class="pd-tree-container"> ${l} <span class="${a}">${c}</span> </span> `}function f(e,t,i,s,o){var r={};return Object.keys(s).forEach((function(e){r[e]=s[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),r),o&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(o):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}let w=(f((p=class{constructor(e,t,i){this._column_sizes=e,this._container=t,this.table=i,this.cells=[],this.rows=[]}num_rows(){return this.cells.length}_set_metadata(e,t){r.set(e,t)}_get_or_create_metadata(e){if(r.has(e))return r.get(e);{const t={};return r.set(e,t),t}}_format_text(e){const t=Object(u.get_type_config)(e),i=t.type||e,s={float:Intl.NumberFormat,integer:Intl.NumberFormat,datetime:Intl.DateTimeFormat,date:Intl.DateTimeFormat}[i];if(s){const e=new s("en-us",t.format);return t=>e.format(t)}return e=>e}_format_class(e){const t=Object(u.get_type_config)(e).type||e;return"integer"===t||"float"===t?e=>e>0?"pd-positive":e<0?"pd-negative":void 0:()=>""}_format(e){if(Array.isArray(e))return{format:m.bind(this)};const t=this._format_text(e),i=this._format_class(e);return{format(e,s){e.textContent=t(s);const o=i(s);o&&e.classList.add(o)}}}_get_cell(e="td",t,i,s){let o=t[i];return o||(o=t[i]=document.createElement(e),s.appendChild(o)),o}_get_row(e){let t=this.rows[e];t||(t=this.rows[e]=document.createElement("tr"),this.table.appendChild(t));let i=this.cells[e];return i||(i=this.cells[e]=[]),{tr:t,row_container:i}}_clean_columns(e){for(let t=0;t<this.rows.length;t++){const i=this.rows[t],s=this.cells[t];let o=e[t]||e;for(;i.children[o];)i.removeChild(i.children[o]);this.cells[t]=s.slice(0,o)}}_clean_rows(e){for(;this.table.children[e];)this.table.removeChild(this.table.children[e]);this.rows=this.rows.slice(0,e),this.cells=this.cells.slice(0,e)}}).prototype,"_format_text",[_],Object.getOwnPropertyDescriptor(p.prototype,"_format_text"),p.prototype),f(p.prototype,"_format_class",[_],Object.getOwnPropertyDescriptor(p.prototype,"_format_class"),p.prototype),f(p.prototype,"_format",[_],Object.getOwnPropertyDescriptor(p.prototype,"_format"),p.prototype),p);function g(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class b extends w{constructor(...e){super(...e),g(this,"_group_header_cache",[]),g(this,"_offset_cache",[])}_draw_group_th(e,t,i,s){const{tr:o,row_container:r}=this._get_row(t),n=this._get_cell("th",r,e[t],o);if(e[t]+=1,n.className="",n.removeAttribute("colspan"),n.style.minWidth="0",0===(null==s?void 0:s.length))n.innerHTML=h` <span>${i}</span> <span class="pd-column-resize"></span> `;else{const e=null==s?void 0:s.map(e=>{const t=a[e];return h` <span class="pd-column-header-icon">${t}</span> `}).join("");n.innerHTML=h` <span>${i}</span> ${e} <span class="pd-column-resize"></span> `}return n}_redraw_previous(e,t){const{tr:i,row_container:s}=this._get_row(t),o=e[t]-1;if(o<0)return;const r=this._get_cell("th",s,o,i);return r?(r.classList.add("pd-group-header"),r):void 0}_draw_group(e,t,i,s){const o=this._get_or_create_metadata(s);return o.column_path=e,o.column_name=t,o.column_type=i,o.is_column_header=!1,s.className="",o}_draw_th(e,t,i,s){const o=this._get_or_create_metadata(s);o.column_path=e,o.column_name=t,o.column_type=i,o.is_column_header=!0,o.size_key=`${e}|${i}`;const r=this._column_sizes.auto[o.size_key],n=this._column_sizes.override[o.size_key];return s.classList.add(`pd-${i}`),n?(s.classList.toggle("pd-cell-clip",r>n),s.style.minWidth=n+"px",s.style.maxWidth=n+"px"):r&&(s.classList.remove("pd-cell-clip"),s.style.maxWidth="",s.style.minWidth=r+"px"),o}get_column_header(e){const{tr:t,row_container:i}=this._get_row(this.rows.length-1);return this._get_cell("th",i,e,t)}draw(e,t,i,s,o){var r;const n=e.column_pivots.length+1;let a,l,c=null===(r=i.split)||void 0===r?void 0:r.call(i,"|"),_=!1;for(let r=0;r<n;r++)if(l=c[r]?c[r]:"",this._offset_cache[r]=this._offset_cache[r]||0,r<n-1){var d,h,p;if((null===(d=this._group_header_cache)||void 0===d?void 0:null===(h=d[r])||void 0===h?void 0:null===(p=h[0])||void 0===p?void 0:p.column_name)===l)a=this._group_header_cache[r][1],this._group_header_cache[r][2]+=1,a.setAttribute("colspan",this._group_header_cache[r][2]);else{a=this._draw_group_th(this._offset_cache,r,l,[]);const e=this._draw_group(i,l,s,a);this._group_header_cache[r]=[e,a,1],_=!0}}else{var u;_&&this._redraw_previous(this._offset_cache,r);const n=this._offset_cache[r],c=null===(u=e.sort)||void 0===u?void 0:u.filter(e=>e[0]===l).map(e=>e[1]);a=this._draw_group_th(this._offset_cache,r,l,c);const d=this._draw_th(t||i,l,s,a);d.vcidx=n,d.cidx=o;for(const[e]of this._group_header_cache)e.cidx=o,e.vcidx=n,e.size_key=d.size_key}1===n&&Array.isArray(s)&&a.classList.add("pd-group-header");const v=this._get_or_create_metadata(a);return this._clean_rows(this._offset_cache.length),{th:a,metadata:v}}clean(){this._clean_columns(this._offset_cache),this._offset_cache=[],this._group_header_cache=[]}}var y=i(1),x=i.n(y);class z extends w{_draw_td(e,t,i,s,{cidx:o,column_name:r,type:n},{selected_id:a,depth:l,ridx_offset:c,cidx_offset:_}){const{tr:d,row_container:h}=this._get_row(e);if(!1!==a){const e=x()(i,a),t=!e&&x()(null==i?void 0:i.slice(0,null==a?void 0:a.length),a);d.classList.toggle("pd-selected",!!i&&e),d.classList.toggle("pd-sub-selected",!!i&&t)}const p=this._get_cell("td",h,o,d),u=this._get_or_create_metadata(p);u.id=i,u.cidx=o+_,u.type=n,u.column=r,u.size_key=`${r}|${n}`,u.ridx=e+c,p.className=`pd-${n}`;const v=this._column_sizes.override[u.size_key];if(v){const e=this._column_sizes.auto[u.size_key];p.classList.toggle("pd-cell-clip",e>v),p.style.minWidth=v+"px",p.style.maxWidth=v+"px"}else p.classList.remove("pd-cell-clip"),p.style.minWidth="",p.style.maxWidth="";const m=this._format(n);return null==t?(p.textContent="-",u.value=null,u.row_path=null):m?(m.format(p,t,n,t.length===l,s),u.value=Array.isArray(t)?t[t.length-1]:t,u.row_path=t,u.is_open=s):(p.textContent=t,u.value=t),{td:p,metadata:u}}draw(e,t,i){const{cidx:s,column_data:o,id_column:r}=t;let n,a,{row_height:l}=i,c=0;for(const s of o){const _=o[c+1],d=null==r?void 0:r[c],h=this._draw_td(c++,s,d,(null==_?void 0:_.length)>(null==s?void 0:s.length),t,i);if(n=h.td,a=h.metadata,l=l||n.offsetHeight,c*l>e)break}return this._clean_rows(c),{td:n,cidx:s,ridx:c,metadata:a,row_height:l}}clean({ridx:e,cidx:t}){this._clean_rows(e),this._clean_columns(t)}}class k{constructor(e,t,i){i.innerHTML=h` <table cellspacing="0"> <thead></thead> <tbody></tbody> </table> `;const[s]=i.children,[o,r]=s.children;this.table=s,this._column_sizes=t,this.header=new b(t,e,o),this.body=new z(t,e,r),this.fragment=document.createDocumentFragment()}num_columns(){var e;return this.header._get_row(Math.max(0,(null===(e=this.header.rows)||void 0===e?void 0:e.length)-1||0)).row_container.length}autosize_cells(e){for(;e.length>0;){const[t,i]=e.shift(),s=t.offsetWidth;this._column_sizes.row_height=this._column_sizes.row_height||t.offsetHeight,this._column_sizes.indices[i.cidx]=s;const o=this._column_sizes.override.hasOwnProperty(i.size_key);s&&!o&&(this._column_sizes.auto[i.size_key]=s)}}async draw(e,t,i,s,o){const{width:r,height:n}=e,{view:a,config:l,column_paths:c,schema:_,table_schema:h}=t,p=c.slice(o.start_col),u=await a.to_columns(o),{start_row:v,start_col:m}=o,f=l.row_pivots.length,w=u.__ID__,g={viewport_width:0,selected_id:i,depth:f,ridx_offset:v,cidx_offset:m,row_height:this._column_sizes.row_height};let b,y=0,x=[];if("__ROW_PATH__"===c[0]){var z;const e=l.row_pivots.join(","),t=l.row_pivots.map(e=>h[e]),i={column_name:e,cidx:0,column_data:u.__ROW_PATH__,id_column:w,type:t},o=this.header.draw(l,e,"",t,0);b=this.body.draw(n,i,{...g,cidx_offset:0}),g.selected_id=!1,g.viewport_width+=this._column_sizes.indices[0]||(null===(z=b.td)||void 0===z?void 0:z.offsetWidth)||o.th.offsetWidth,g.row_height=g.row_height||b.row_height,y++,s||x.push([b.td||o.th,b.metadata||o.metadata])}try{for(;y<p.length;){var k;const e=p[y];if(!u[e]){let t=Math.max(o.end_col,0);o.start_col=t,o.end_col=t+1;const i=await a.to_columns(o);e in i||(i[e]=[]),u[e]=i[e]}const t=d(_,e),i={column_name:e,cidx:y,column_data:u[e],id_column:w,type:t},c=this.header.draw(l,void 0,e,t,y+m);if(b=this.body.draw(n,i,g),g.selected_id=!1,g.viewport_width+=this._column_sizes.indices[y+m]||(null===(k=b.td)||void 0===k?void 0:k.offsetWidth)||c.th.offsetWidth,g.row_height=g.row_height||b.row_height,y++,s||x.push([b.td||c.th,b.metadata||c.metadata]),g.viewport_width>r)break}return x}finally{var j;this.body.clean({ridx:(null===(j=b)||void 0===j?void 0:j.ridx)||0,cidx:y}),this.header.clean()}}}var j,L=i(7),O=i.n(L),E=i(3),M=i.n(E);function W(){return Reflect.construct(HTMLElement,[],this.__proto__.constructor)}Object.setPrototypeOf(W.prototype,HTMLElement.prototype),Object.setPrototypeOf(W,HTMLElement);let T=(P=(j=class extends W{constructor(){super()}create_shadow_dom(){this.attachShadow({mode:"open"});const e="<slot></slot>";this.shadowRoot.innerHTML=h` <style> ${O.a+M.a} </style> <div class="pd-scroll-container"> <div class="pd-virtual-panel">${this._virtual_scrolling_disabled&&e}</div> <div class="pd-scroll-table-clip">${this._virtual_scrolling_disabled||e}</div> <div style="position: absolute; visibility: hidden;"></div> </div> `;const t=document.createElement("div"),[,i]=this.shadowRoot.children,[s,o,r]=i.children;this._sticky_container=t,this._table_clip=o,this._table_staging=r,this._scroll_container=i,this._virtual_panel=s}_calculate_viewport(e,t){const i=this._view_cache.config.row_pivots.length>0;if(this._virtual_scrolling_disabled)return{id:i};const{start_row:s,end_row:o}=this._calculate_row_range(e,t),{start_col:r,end_col:n}=this._calculate_column_range();return this._nrows=e,{start_col:r,end_col:n,start_row:s,end_row:o,id:i}}_calculate_row_range(e,t){const{height:i}=this._container_size,s=this._column_sizes.row_height||19,o=this._view_cache.config.column_pivots.length+1,r=Math.max(1,this._virtual_panel.offsetHeight-this._scroll_container.offsetHeight),n=this._scroll_container.scrollTop/r,a=Math.floor(i/s),l=t?e:this._nrows||0,c=Math.max(0,l+(o-a));let _=Math.round(c*n);return{start_row:_,end_row:_+a}}_calculate_column_range(){const e=Math.max(1,this._virtual_panel.offsetWidth-this._container_size.width),t=this._scroll_container.scrollLeft/e,i=this._max_scroll_column()+.5;let s=Math.floor(i*t);return{start_col:s,end_col:s+(this.table_model.num_columns()||1)+1}}_max_scroll_column(){let e=0;this._view_cache.config.row_pivots.length>0&&(e=this._column_sizes.indices[0]);let t=this._view_cache.column_paths.length;for(;e<this._container_size.width&&t>=0;)t--,e+=this._column_sizes.indices[t]||60;const i=this._view_cache.config.row_pivots.length>0;return Math.min(this._view_cache.column_paths.length-(i?2:1),t+(i?0:1))}_validate_viewport({start_col:e,end_col:t,start_row:i,end_row:s}){const o=this._start_col!==e,r=this._start_row!==i||this._end_row!==s||this._end_col!==t;return this._start_col=e,this._end_col=t,this._start_row=i,this._end_row=s,{invalid_column:o,invalid_row:r}}_needs_swap({invalid_row:e,invalid_column:t}){return this._invalid_schema||!1}_swap_in(e){this._virtual_scrolling_disabled||(this._needs_swap(e)?(this._sticky_container===this.table_model.table.parentElement&&this._sticky_container.replaceChild(this.table_model.table.cloneNode(!0),this.table_model.table),this._table_staging.appendChild(this.table_model.table)):this._sticky_container!==this.table_model.table.parentElement&&this._sticky_container.replaceChild(this.table_model.table,this._sticky_container.children[0])),this._render_element.dispatchEvent(new CustomEvent("perspective-datagrid-before-update",{bubbles:!0,detail:this}))}_swap_out(e){!this._virtual_scrolling_disabled&&this._needs_swap(e)&&this._sticky_container.replaceChild(this.table_model.table,this._sticky_container.children[0]),this._render_element.dispatchEvent(new CustomEvent("perspective-datagrid-after-update",{bubbles:!0,detail:this}))}_update_virtual_panel_width(e){if(e){const e=Math.max(1,this._virtual_panel.offsetWidth-this._container_size.width),t=this._scroll_container.scrollLeft/e,i=this._max_scroll_column();let s=0,o=0;for(;s<i;)o+=this._column_sizes.indices[s]||60,s++;const r=this._container_size.width+o;this._virtual_panel.style.width=r+"px",this._scroll_container.scrollLeft=t*o}}_update_virtual_panel_height(e){const{row_height:t=19}=this._column_sizes,i=Math.min(1e7,e*t);this._virtual_panel.style.height=`${i}px`}infer_options(e){if(e=Object.assign({},e),!this._view_cache)return{};const t=Object.assign({},this._view_cache.config);return delete t.sort,delete e.sort,{reset_scroll_position:!x()(e,t)}}async draw(e={}){const t=n&&performance.now(),{reset_scroll_position:i=!1,preserve_width:s=!1,invalid_viewport:o=!1}=e;if(void 0===this._view_cache.column_paths)return;i&&this.reset_scroll();const r=await this._view_cache.view.num_rows();this._virtual_scrolling_disabled?this._container_size={width:1/0,height:1/0}:this._container_size=!this._invalid_schema&&this._container_size||{width:this._sticky_container.offsetWidth,height:this._sticky_container.offsetHeight};const a=this._calculate_viewport(r,i),c=this._validate_viewport(a),{invalid_row:_,invalid_column:d}=c;if(this._update_virtual_panel_height(r),this._invalid_schema||_||d||o){this._swap_in(c);const e=await this.table_model.draw(this._container_size,this._view_cache,this._selected_id,s,a);this._swap_out(c),this.table_model.autosize_cells(e),s||this._update_virtual_panel_width(this._invalid_schema||d||o),this._invalid_schema=!1}var h;n&&(h=performance.now()-t,l.push(h))}}).prototype,C="draw",H=[s.throttlePromise],$=Object.getOwnPropertyDescriptor(j.prototype,"draw"),A=j.prototype,q={},Object.keys($).forEach((function(e){q[e]=$[e]})),q.enumerable=!!q.enumerable,q.configurable=!!q.configurable,("value"in q||q.initializer)&&(q.writable=!0),q=H.slice().reverse().reduce((function(e,t){return t(P,C,e)||e}),q),A&&void 0!==q.initializer&&(q.value=q.initializer?q.initializer.call(A):void 0,q.initializer=void 0),void 0===q.initializer&&(Object.defineProperty(P,C,q),q=null),j);var P,C,H,$,A,q,D;let N=(function(e,t,i,s,o){var r={};Object.keys(s).forEach((function(e){r[e]=s[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),r),o&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(o):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null)}((D=class extends T{register_listeners(){this._scroll_container.addEventListener("scroll",this._on_scroll.bind(this),{passive:!1}),this._scroll_container.addEventListener("mousewheel",this._on_mousewheel.bind(this),{passive:!1}),this._sticky_container.addEventListener("mousedown",this._on_click.bind(this)),this._sticky_container.addEventListener("dblclick",this._on_dblclick.bind(this))}async _on_scroll(e){e.stopPropagation(),e.returnValue=!1,await this.draw(),this._render_element.dispatchEvent(new CustomEvent("perspective-datagrid-scroll"))}_on_mousewheel(e){if(this._virtual_scrolling_disabled)return;e.preventDefault(),e.returnValue=!1;const{offsetWidth:t,offsetHeight:i,scrollTop:s,scrollLeft:o}=this._scroll_container,r=Math.max(1,this._virtual_panel.offsetHeight-i),n=Math.max(1,this._virtual_panel.offsetWidth-t);this._scroll_container.scrollTop=Math.min(r,s+e.deltaY),this._scroll_container.scrollLeft=Math.min(n,o+e.deltaX),this._on_scroll(e)}async _on_dblclick(e){let t=e.target;for(;"TD"!==t.tagName&&"TH"!==t.tagName;)if(t=t.parentElement,!this._sticky_container.contains(t))return;const i=e.target.classList.contains("pd-column-resize"),s=r.get(t);if(i){await new Promise(setTimeout),delete this._column_sizes.override[s.size_key],delete this._column_sizes.auto[s.size_key],delete this._column_sizes.indices[s.cidx],t.style.minWidth="",t.style.maxWidth="";for(const e of this.table_model.body.cells){const t=e[s.cidx];t.style.minWidth="",t.style.maxWidth="",t.classList.remove("pd-cell-clip")}await this.draw({invalid_viewport:!0})}}async _on_click(e){if(0!==e.button)return;let t=e.target;for(;"TD"!==t.tagName&&"TH"!==t.tagName;)if(t=t.parentElement,!this._sticky_container.contains(t))return;const i=e.target.classList.contains("pd-row-header-icon"),s=e.target.classList.contains("pd-column-resize"),o=r.get(t);i?await this._on_toggle(e,o):s?this._on_resize_column(e,t,o):(null==o?void 0:o.is_column_header)?await this._on_sort(e,o):await this._on_select(o)}_on_resize_column(e,t,i){const s=e.pageX;t=this.table_model.header.get_column_header(i.vcidx);const o=this._column_sizes.indices[i.cidx],r=e=>this._on_resize_column_move(e,t,s,o,i),n=async()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n);const e=this._column_sizes.override[i.size_key];this._column_sizes.indices[i.cidx]=e,await this.draw({invalid_viewport:!0})};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)}async _on_resize_column_move(e,t,i,s,o){await new Promise(setTimeout);const r=e.pageX-i,n=s+r;if(this._column_sizes.override[o.size_key]=n,r<0)await this.draw({invalid_viewport:!0,preserve_width:!0});else{t.style.minWidth=n+"px",t.style.maxWidth=n+"px";const e=this._column_sizes.auto[o.size_key];for(const t of this.table_model.body.cells){const i=t[o.vcidx];i.style.maxWidth=i.style.minWidth=n+"px",i.classList.toggle("pd-cell-clip",e>n)}}}async _on_select(e){if(!this._render_element.hasAttribute("selectable"))return;const t=x()(e.id,this._selected_id);let i=[];t?(this._selected_id=void 0,await this.draw({invalid_viewport:!0})):(this._selected_id=e.id,await this.draw({invalid_viewport:!0}),i=await async function({view:e,config:t},i,s){const o=t.row_pivots,r=t.column_pivots,n=i>=0?i:0,a=n+1,l=await e.to_json({start_row:n,end_row:a}),c=l.map(e=>e.__ROW_PATH__)[0]||[],_=o.map((e,t)=>{const i=c[t];return i?[e,"==",i]:void 0}).filter(e=>e),d=o.length>0?s+1:s,h=Object.keys(l[0])[d],p={row:l[0]};let u=[];if(h){const e=h.split("|");p.column_names=[e[e.length-1]],u=r.map((t,i)=>{const s=e[i];return s?[t,"==",s]:void 0}).filter(e=>e).filter(([,,e])=>"__ROW_PATH__"!==e)}const v=t.filter.concat(_).concat(u);return p.config={filters:v},p}(this._view_cache,e.ridx,e.cidx),i=i.config.filters),this._render_element.dispatchEvent(new CustomEvent("perspective-select",{bubbles:!0,composed:!0,detail:{selected:!t,config:{filters:i}}}))}async _on_toggle(e,t){t.is_open?e.shiftKey?await this._view_cache.view.set_depth(t.row_path.length-1):await this._view_cache.view.collapse(t.ridx):!1===t.is_open&&(e.shiftKey?await this._view_cache.view.set_depth(t.row_path.length):await this._view_cache.view.expand(t.ridx)),await this.draw({invalid_viewport:!0})}async _on_sort(e,t){let i=this._view_cache.config.sort.slice();const s=i.findIndex(e=>e[0]===t.column_name);if(s>-1){const o=i[s][1],r=this._render_element._increment_sort(o,!1,e.altKey);i[s]=[t.column_name,r]}else{let s=e.altKey?"asc abs":"asc";const o=[t.column_name,s];e.shiftKey?i.push(o):i=[o]}this._render_element.setAttribute("sort",JSON.stringify(i))}}).prototype,"_on_resize_column_move",[s.throttlePromise],Object.getOwnPropertyDescriptor(D.prototype,"_on_resize_column_move"),D.prototype),D);function R(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class I{static async update(e){try{const t=o.get(e);await t.draw({invalid_viewport:!0})}catch(e){return}}static async create(e,t){const i=function(e,t){let i;return o.has(t)?i=o.get(t):(i=document.createElement("perspective-datagrid"),i.appendChild(document.createElement("slot")),i.set_element(e),i.register_listeners(),t.innerHTML="",t.appendChild(i),o.set(t,i)),i.isConnected||(i.clear(),t.innerHTML="",t.appendChild(i)),i}(this,e),s=await i.set_view(t);await i.draw(s)}static async resize(){if(this.view&&o.has(this._datavis)){const e=o.get(this._datavis);e.reset_size(),await e.draw({invalid_viewport:!0})}}}R(I,"name","Datagrid"),R(I,"selectMode","toggle"),R(I,"deselectMode","pivots"),window.customElements.define("perspective-datagrid",class extends N{get_meta(e){return r.get(e)}get_tds(){return this.table_model.body.cells.flat(1)}get_ths(){return this.table_model.body.cells.flat(1)}clear(){this._sticky_container.innerHTML="<table></table>",this._render_element?this._render_element!==this.table_model.table.parentElement&&this._render_element.appendChild(this._sticky_container):this.appendChild(this.table_model.table)}reset_viewport(){this._start_row=void 0,this._end_row=void 0,this._start_col=void 0,this._end_col=void 0}reset_size(){this._container_size=void 0}reset_scroll(){this._column_sizes.indices=[],this._scroll_container.scrollTop=0,this._scroll_container.scrollLeft=0,this.reset_viewport()}async set_view(e){const t=await e.get_config(),i=await this._render_element.table.schema(),s=await e.schema(),o=await e.column_paths();this._invalid_schema=!0;const r=this.infer_options(t);return this._view_cache={view:e,config:t,column_paths:o,schema:s,table_schema:i},r}set_element(e){e&&(this._render_element=e),this._virtual_scrolling_disabled=e.hasAttribute("disable-virtual-datagrid"),this.create_shadow_dom(),this._column_sizes={auto:{},override:{},indices:[]},this.table_model=new k(this._table_clip,this._column_sizes,this._sticky_container),this.table_model&&(this._render_element?this._render_element!==this.table_model.table.parentElement&&this._render_element.appendChild(this._sticky_container):this.appendChild(this.table_model.table))}}),Object(s.registerPlugin)("datagrid",I),n&&setInterval(c,5e3),function(){const e=document.createElement("style");e.textContent=M.a,document.head.appendChild(e)}()}])}));
//# sourceMappingURL=perspective-viewer-datagrid.js.map