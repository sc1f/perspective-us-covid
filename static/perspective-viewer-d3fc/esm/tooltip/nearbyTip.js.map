{"version":3,"sources":["../../../src/js/tooltip/nearbyTip.js"],"names":["fc","tooltip","withOpacity","findBestFromData","raiseEvent","base","alwaysShow","xScale","yScale","color","size","canvas","data","xValueName","yValueName","altDataWithScale","nearbyTip","selection","chartPlotArea","tooltipData","pointer","on","event","closest","length","getClosestDataPoint","useYScale","scale","renderTip","select","node","settings","call","tipData","tips","selectAll","exit","remove","enter","append","attr","merge","d","Math","sqrt","style","key","pos","distFn","v","undefined","pow","x","y","dist1","best1","min","dist2","best2","args","copy","range","rebindAll"],"mappings":"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","sourcesContent":["/******************************************************************************\r\n *\r\n * Copyright (c) 2017, the Perspective Authors.\r\n *\r\n * This file is part of the Perspective library, distributed under the terms of\r\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\r\n *\r\n */\r\n\r\nimport * as fc from \"d3fc\";\r\nimport {tooltip} from \"./tooltip\";\r\nimport {withOpacity} from \"../series/seriesColors.js\";\r\nimport {findBestFromData} from \"../data/findBest\";\r\nimport {raiseEvent} from \"./selectionEvent\";\r\n\r\nexport default () => {\r\n    const base = tooltip().alwaysShow(true);\r\n\r\n    let xScale = null;\r\n    let yScale = null;\r\n    let color = null;\r\n    let size = null;\r\n    let canvas = false;\r\n    let data = null;\r\n    let xValueName = \"crossValue\";\r\n    let yValueName = \"mainValue\";\r\n    let altDataWithScale = null;\r\n\r\n    function nearbyTip(selection) {\r\n        const chartPlotArea = `d3fc-${canvas ? \"canvas\" : \"svg\"}.plot-area`;\r\n        if (xScale || yScale) {\r\n            let tooltipData = null;\r\n            const pointer = fc.pointer().on(\"point\", event => {\r\n                const closest = event.length ? getClosestDataPoint(event[0]) : null;\r\n                tooltipData = closest ? [closest.data] : [];\r\n                const useYScale = closest ? closest.scale : yScale;\r\n\r\n                renderTip(selection, tooltipData, useYScale);\r\n            });\r\n\r\n            selection\r\n                .select(chartPlotArea)\r\n                .on(\"measure.nearbyTip\", () => renderTip(selection, []))\r\n                .on(\"click\", () => {\r\n                    if (tooltipData.length) {\r\n                        raiseEvent(selection.node(), tooltipData[0], base.settings());\r\n                    }\r\n                })\r\n                .call(pointer);\r\n        }\r\n    }\r\n\r\n    const renderTip = (selection, tipData, useYScale = yScale) => {\r\n        const tips = selection\r\n            .select(\"d3fc-svg.plot-area svg\")\r\n            .selectAll(\"circle.nearbyTip\")\r\n            .data(tipData);\r\n        tips.exit().remove();\r\n\r\n        tips.enter()\r\n            .append(\"circle\")\r\n            .attr(\"class\", \"nearbyTip\")\r\n            .merge(tips)\r\n            .attr(\"r\", d => (size ? Math.sqrt(size(d.size)) : 10))\r\n            .attr(\"transform\", d => `translate(${xScale(d[xValueName])},${useYScale(d[yValueName])})`)\r\n            .style(\"stroke\", \"none\")\r\n            .style(\"fill\", d => color && withOpacity(color(d.key)));\r\n\r\n        base(tips);\r\n    };\r\n\r\n    const getClosestDataPoint = pos => {\r\n        const distFn = scale => {\r\n            return v => {\r\n                if (v[yValueName] === undefined || v[yValueName] === null || v[xValueName] === undefined || v[xValueName] === null) return null;\r\n\r\n                return Math.sqrt(Math.pow(xScale(v[xValueName]) - pos.x, 2) + Math.pow(scale(v[yValueName]) - pos.y, 2));\r\n            };\r\n        };\r\n\r\n        // Check the main data\r\n        const dist1 = distFn(yScale);\r\n        const best1 = findBestFromData(data, dist1, Math.min);\r\n\r\n        if (altDataWithScale) {\r\n            // Check the alt data with its scale, to see if any are closer\r\n            const dist2 = distFn(altDataWithScale.yScale);\r\n            const best2 = findBestFromData(altDataWithScale.data, dist2, Math.min);\r\n            return dist1(best1) <= dist2(best2) ? {data: best1, scale: yScale} : {data: best2, scale: altDataWithScale.yScale};\r\n        }\r\n        return {data: best1, scale: yScale};\r\n    };\r\n\r\n    nearbyTip.xScale = (...args) => {\r\n        if (!args.length) {\r\n            return xScale;\r\n        }\r\n        xScale = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.yScale = (...args) => {\r\n        if (!args.length) {\r\n            return yScale;\r\n        }\r\n        yScale = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.color = (...args) => {\r\n        if (!args.length) {\r\n            return color;\r\n        }\r\n        color = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.size = (...args) => {\r\n        if (!args.length) {\r\n            return size;\r\n        }\r\n        size = args[0] ? args[0].copy().range([40, 4000]) : null;\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.canvas = (...args) => {\r\n        if (!args.length) {\r\n            return canvas;\r\n        }\r\n        canvas = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.data = (...args) => {\r\n        if (!args.length) {\r\n            return data;\r\n        }\r\n        data = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.xValueName = (...args) => {\r\n        if (!args.length) {\r\n            return xValueName;\r\n        }\r\n        xValueName = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.yValueName = (...args) => {\r\n        if (!args.length) {\r\n            return yValueName;\r\n        }\r\n        yValueName = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    nearbyTip.altDataWithScale = (...args) => {\r\n        if (!args.length) {\r\n            return altDataWithScale;\r\n        }\r\n        altDataWithScale = args[0];\r\n        return nearbyTip;\r\n    };\r\n\r\n    fc.rebindAll(nearbyTip, base);\r\n    return nearbyTip;\r\n};\r\n"],"file":"nearbyTip.js"}