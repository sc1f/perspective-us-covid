{"version":3,"sources":["../../../src/js/plugin/plugin.js"],"names":["registerPlugin","charts","PRIVATE","Symbol","DEFAULT_PLUGIN_SETTINGS","initial","type","count","selectMode","register","plugins","Set","length","map","chart","plugin","forEach","has","create","drawChart","resize","resizeChart","delete","deleteChart","save","restore","el","view","task","end_col","end_row","jsonp","realValues","JSON","parse","getAttribute","to_json","leaves_only","tschema","schema","json","config","Promise","all","_table","get_config","cancelled","columns","row_pivots","column_pivots","filter","filtered","col","__ROW_PATH__","dataMap","i","mapped","settings","crossValues","r","name","mainValues","a","splitValues","data","createOrUpdateChart","call","getOrCreatePluginElement","perspective_d3fc_element","document","createElement","div","body","contains","innerHTML","appendChild","render","getSettings","setSettings","Element","prototype","matches","msMatchesSelector"],"mappings":"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","sourcesContent":["/******************************************************************************\r\n *\r\n * Copyright (c) 2017, the Perspective Authors.\r\n *\r\n * This file is part of the Perspective library, distributed under the terms of\r\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\r\n *\r\n */\r\n\r\nimport {registerPlugin} from \"@finos/perspective-viewer/dist/esm/utils.js\";\r\nimport charts from \"../charts/charts\";\r\nimport \"./polyfills/index\";\r\nimport \"./template\";\r\n\r\nexport const PRIVATE = Symbol(\"D3FC chart\");\r\n\r\nconst DEFAULT_PLUGIN_SETTINGS = {\r\n    initial: {\r\n        type: \"number\",\r\n        count: 1\r\n    },\r\n    selectMode: \"select\"\r\n};\r\n\r\nexport function register(...plugins) {\r\n    plugins = new Set(plugins.length > 0 ? plugins : charts.map(chart => chart.plugin.type));\r\n    charts.forEach(chart => {\r\n        if (plugins.has(chart.plugin.type)) {\r\n            registerPlugin(chart.plugin.type, {\r\n                ...DEFAULT_PLUGIN_SETTINGS,\r\n                ...chart.plugin,\r\n                create: drawChart(chart),\r\n                resize: resizeChart,\r\n                delete: deleteChart,\r\n                save,\r\n                restore\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\nfunction drawChart(chart) {\r\n    return async function(el, view, task, end_col, end_row) {\r\n        let jsonp;\r\n        const realValues = JSON.parse(this.getAttribute(\"columns\"));\r\n\r\n        if (end_col && end_row) {\r\n            jsonp = view.to_json({end_row, end_col, leaves_only: true});\r\n        } else if (end_col) {\r\n            jsonp = view.to_json({end_col, leaves_only: true});\r\n        } else if (end_row) {\r\n            jsonp = view.to_json({end_row, leaves_only: true});\r\n        } else {\r\n            jsonp = view.to_json({leaves_only: true});\r\n        }\r\n\r\n        let [tschema, schema, json, config] = await Promise.all([this._table.schema(false), view.schema(false), jsonp, view.get_config()]);\r\n\r\n        if (task.cancelled) {\r\n            return;\r\n        }\r\n\r\n        const {columns, row_pivots, column_pivots, filter} = config;\r\n        const filtered = row_pivots.length > 0 ? json.filter(col => col.__ROW_PATH__ && col.__ROW_PATH__.length == row_pivots.length) : json;\r\n        const dataMap = (col, i) => (!row_pivots.length ? {...col, __ROW_PATH__: [i]} : col);\r\n        const mapped = filtered.map(dataMap);\r\n\r\n        let settings = {\r\n            realValues,\r\n            crossValues: row_pivots.map(r => ({name: r, type: tschema[r]})),\r\n            mainValues: columns.map(a => ({name: a, type: schema[a]})),\r\n            splitValues: column_pivots.map(r => ({name: r, type: tschema[r]})),\r\n            filter,\r\n            data: mapped\r\n        };\r\n\r\n        createOrUpdateChart.call(this, el, chart, settings);\r\n    };\r\n}\r\n\r\nfunction getOrCreatePluginElement() {\r\n    let perspective_d3fc_element;\r\n    this[PRIVATE] = this[PRIVATE] || {};\r\n    if (!this[PRIVATE].chart) {\r\n        perspective_d3fc_element = this[PRIVATE].chart = document.createElement(\"perspective-d3fc-chart\");\r\n    } else {\r\n        perspective_d3fc_element = this[PRIVATE].chart;\r\n    }\r\n    return perspective_d3fc_element;\r\n}\r\n\r\nfunction createOrUpdateChart(div, chart, settings) {\r\n    const perspective_d3fc_element = getOrCreatePluginElement.call(this);\r\n\r\n    if (!document.body.contains(perspective_d3fc_element)) {\r\n        div.innerHTML = \"\";\r\n        div.appendChild(perspective_d3fc_element);\r\n    }\r\n\r\n    perspective_d3fc_element.render(chart, settings);\r\n}\r\n\r\nfunction resizeChart() {\r\n    if (this[PRIVATE] && this[PRIVATE].chart) {\r\n        const perspective_d3fc_element = this[PRIVATE].chart;\r\n        perspective_d3fc_element.resize();\r\n    }\r\n}\r\n\r\nfunction deleteChart() {\r\n    if (this[PRIVATE] && this[PRIVATE].chart) {\r\n        const perspective_d3fc_element = this[PRIVATE].chart;\r\n        perspective_d3fc_element.delete();\r\n    }\r\n}\r\n\r\nfunction save() {\r\n    if (this[PRIVATE] && this[PRIVATE].chart) {\r\n        const perspective_d3fc_element = this[PRIVATE].chart;\r\n        return perspective_d3fc_element.getSettings();\r\n    }\r\n}\r\n\r\nfunction restore(config) {\r\n    const perspective_d3fc_element = getOrCreatePluginElement.call(this);\r\n    perspective_d3fc_element.setSettings(config);\r\n}\r\n\r\nif (!Element.prototype.matches) {\r\n    Element.prototype.matches = Element.prototype.msMatchesSelector;\r\n}\r\n"],"file":"plugin.js"}